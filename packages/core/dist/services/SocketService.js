'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _assign=require('babel-runtime/core-js/object/assign'),_assign2=_interopRequireDefault(_assign),_promise=require('babel-runtime/core-js/promise'),_promise2=_interopRequireDefault(_promise),_stringify=require('babel-runtime/core-js/json/stringify'),_stringify2=_interopRequireDefault(_stringify),_StorageService=require('./StorageService'),_StorageService2=_interopRequireDefault(_StorageService),_getRandomValues=require('get-random-values'),_getRandomValues2=_interopRequireDefault(_getRandomValues),_createHash=require('create-hash'),_createHash2=_interopRequireDefault(_createHash);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const host='127.0.0.1:50005';let plugin,socket=null,connected=!1,paired=!1,openRequests=[],allowReconnects=!0,reconnectionTimeout=null;const sha256=a=>(0,_createHash2.default)('sha256').update(a).digest('hex'),reconnectOnAbnormalDisconnection=()=>{clearTimeout(reconnectionTimeout),reconnectionTimeout=setTimeout(()=>{SocketService.link()},1e3)},random=()=>{const a=new Uint8Array(24);return(0,_getRandomValues2.default)(a),a.join('')},getOrigin=()=>{let a;return a='undefined'==typeof location?plugin:location.hasOwnProperty('hostname')&&location.hostname.length&&'localhost'!==location.hostname?location.hostname:plugin,a};let appkey=_StorageService2.default.getAppKey();appkey||(appkey='appkey:'+random());const send=(a=null,b=null)=>{null===a&&null===b?socket.send('40/scatter'):socket.send('42/scatter,'+(0,_stringify2.default)([a,b]))};let pairingPromise=null;const pair=(a=!1)=>new _promise2.default((b,c)=>{pairingPromise={resolve:b,reject:c},send('pair',{data:{appkey,origin:getOrigin(),passthrough:a},plugin})});class SocketService{static init(a,b=6e4){plugin=a,this.timeout=b}static link(){return _promise2.default.race([new _promise2.default(a=>setTimeout(()=>{connected||(a(!1),socket&&(socket.disconnect(),socket=null),reconnectOnAbnormalDisconnection())},this.timeout)),new _promise2.default(a=>{socket=new WebSocket(`ws://${host}/socket.io/?EIO=3&transport=websocket`),socket.onclose=()=>a(!1),socket.onerror=()=>a(!1),socket.onopen=()=>{send(),clearTimeout(reconnectionTimeout),connected=!0,pair(!0).then(()=>{a(!0)})},socket.onmessage=a=>{if(-1===a.data.indexOf('42/scatter'))return!1;const[e,f]=JSON.parse(a.data.replace('42/scatter,',''));return'paired'===e?b(f):'rekey'===e?c():'api'===e?d(f):void 0};const b=a=>{if(paired=a,paired){const a=_StorageService2.default.getAppKey(),b=-1<appkey.indexOf('appkey:')?sha256(appkey):appkey;a&&a===b||(_StorageService2.default.setAppKey(b),appkey=_StorageService2.default.getAppKey())}pairingPromise.resolve(a)},c=()=>{appkey='appkey:'+random(),send('rekeyed',{data:{appkey,origin:getOrigin()},plugin})},d=a=>{const b=openRequests.find(b=>b.id===a.id);if(b){openRequests=openRequests.filter(b=>b.id!==a.id);const c='object'==typeof a.result&&null!==a.result&&a.result.hasOwnProperty('isError');c?b.reject(a.result):b.resolve(a.result)}}})])}static isConnected(){return connected}static disconnect(){return socket&&socket.disconnect(),!0}static sendApiRequest(a){return new _promise2.default((b,c)=>'identityFromPermissions'!==a.type||paired?void pair().then(()=>{if(!paired)return c({code:'not_paired',message:'The user did not allow this app to connect to their Scatter'});a.id=random(),a.appkey=appkey,a.nonce=_StorageService2.default.getNonce()||0;const d=random();a.nextNonce=sha256(d),_StorageService2.default.setNonce(d),a.hasOwnProperty('payload')&&!a.payload.hasOwnProperty('origin')&&(a.payload.origin=getOrigin()),openRequests.push((0,_assign2.default)(a,{resolve:b,reject:c})),send('api',{data:a,plugin})}):b(!1))}}exports.default=SocketService;